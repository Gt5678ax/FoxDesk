<?php
$user = current_user();
$flash = get_flash();
$settings = get_settings();
$app_name = $settings['app_name'] ?? (defined('APP_NAME') ? APP_NAME : 'FoxDesk');
$app_version = defined('APP_VERSION') ? APP_VERSION : '';
$in_app_notifications_enabled = user_in_app_notifications_enabled($user);
$in_app_sound_enabled = user_in_app_sound_enabled($user);

// Throttled update check for admins (every 12 hours)
$_foxdesk_update_info = false;
if (is_admin() && file_exists(__DIR__ . '/update-check-functions.php')) {
    require_once __DIR__ . '/update-check-functions.php';
    if (is_update_check_enabled()) {
        $last_check = get_setting('update_check_last_run', '');
        if (!$last_check || (time() - strtotime($last_check)) > UPDATE_CHECK_INTERVAL) {
            @check_for_updates(); // silent, stores result in DB
        }
        $_foxdesk_update_info = get_cached_update_info();
    }
}
?>
<!DOCTYPE html>
<html lang="<?php echo e(get_app_language()); ?>">

<head>
    <meta charset="UTF-8">
    <script>
        // Apply theme immediately to prevent flash
        (function() {
            const saved = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', saved);
            
            // Apply corresponding flatpickr theme
            var fpLink = saved === 'dark'
                ? 'https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/themes/dark.css'
                : 'https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.css';
            var link = document.createElement('link');
            link.rel = 'stylesheet';
            link.id = 'flatpickr-theme-css';
            link.href = fpLink;
            document.head.appendChild(link);
        })();
    </script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title"><?php echo e($page_title ?? t('Dashboard')); ?> - <?php echo e($app_name); ?></title>
    <meta name="csrf-token" content="<?php echo e(csrf_token()); ?>">
    <script>
        window.csrfToken = <?php echo json_encode(csrf_token()); ?>;
        window.appName = <?php echo json_encode($app_name); ?>;
        window.originalPageTitle = <?php echo json_encode(($page_title ?? t('Dashboard')) . ' - ' . $app_name); ?>;
        window.appNotificationPrefs = {
            inAppEnabled: <?php echo $in_app_notifications_enabled ? 'true' : 'false'; ?>,
            soundEnabled: <?php echo $in_app_sound_enabled ? 'true' : 'false'; ?>
        };
    </script>

    <!-- Favicon -->
    <?php
    $custom_favicon = $settings['favicon'] ?? '';
    $default_favicon = "data:image/svg+xml," . rawurlencode('<svg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 32 32\'><rect width=\'32\' height=\'32\' rx=\'6\' fill=\'#3b82f6\'/><text x=\'16\' y=\'22\' font-family=\'Arial,sans-serif\' font-size=\'18\' font-weight=\'bold\' fill=\'white\' text-anchor=\'middle\'>' . strtoupper(substr($app_name, 0, 1)) . '</text></svg>');
    $favicon_href = $custom_favicon ? $custom_favicon : $default_favicon;
    $favicon_type = $custom_favicon ? 'image/x-icon' : 'image/svg+xml';
    ?>
    <link rel="icon" id="favicon" type="<?php echo $favicon_type; ?>" href="<?php echo $favicon_href; ?>">
    <!-- Active timer favicon (preloaded for JS swap) -->
    <link rel="preload" id="favicon-timer" as="image" type="image/svg+xml" href="data:image/svg+xml,<?php echo rawurlencode('<svg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 32 32\'><rect width=\'32\' height=\'32\' rx=\'6\' fill=\'#22c55e\'/><circle cx=\'16\' cy=\'16\' r=\'10\' fill=\'none\' stroke=\'white\' stroke-width=\'2\'/><path d=\'M16 10 L16 16 L20 16\' fill=\'none\' stroke=\'white\' stroke-width=\'2\' stroke-linecap=\'round\'/></svg>'); ?>">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <link href="tailwind.min.css?v=<?php echo APP_VERSION; ?>" rel="stylesheet">

    <link href="theme.css?v=<?php echo APP_VERSION; ?>" rel="stylesheet">
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.8/dist/cdn.min.js"></script>
    <script defer src="assets/js/app-header.js?v=<?php echo APP_VERSION; ?>"></script>
    <script defer src="assets/js/shortcuts.js?v=<?php echo APP_VERSION; ?>"></script>

    <!-- Flatpickr Date/Time Library -->
    <script defer src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            function initDatePickers(root) {
                if (typeof flatpickr !== 'undefined') {
                    flatpickr(root.querySelectorAll('input[type="date"], .date-picker'), {
                        dateFormat: "Y-m-d",
                        disableMobile: "true" // Use flatpickr on mobile too for UI consistency
                    });
                    flatpickr(root.querySelectorAll('input[type="datetime-local"], .datetime-picker'), {
                        enableTime: true,
                        dateFormat: "Y-m-d\\TH:i",
                        time_24hr: true,
                        disableMobile: "true"
                    });
                }
            }
            
            // Initialize on load
            initDatePickers(document);
            
            // Auto-init on dynamically added modals
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.addedNodes && mutation.addedNodes.length > 0) {
                        mutation.addedNodes.forEach(function(node) {
                            if (node.nodeType === 1) { // Element node
                                if (node.matches && (node.matches('input[type="date"]') || node.matches('input[type="datetime-local"]'))) {
                                    initDatePickers(node.parentNode);
                                } else if (node.querySelectorAll) {
                                    initDatePickers(node);
                                }
                            }
                        });
                    }
                });
            });
            observer.observe(document.body, { childList: true, subtree: true });
        });
    </script>
</head>

<body class="antialiased font-sans" style="background-color: var(--bg-primary); color: var(--text-primary);">
    <!-- Impersonation Warning Banner -->
    <?php if (function_exists('is_impersonating') && is_impersonating()): ?>
        <div class="bg-red-600 text-white px-4 py-2 flex items-center justify-end gap-4 shadow-md relative z-50">
            <div class="flex items-center gap-2">
                <?php echo get_icon('user-secret', 'w-5 h-5 flex-shrink-0'); ?>
                <span class="font-medium whitespace-nowrap">
                    <?php echo t('Viewing as'); ?>
                    <strong class="ml-1"><?php echo e($_SESSION['user_name']); ?></strong>
                </span>
            </div>
            <a href="<?php echo url('impersonate', ['stop' => 'true']); ?>"
                class="text-red-600 px-3 py-1 rounded text-sm font-bold transition shadow-sm flex-shrink-0 whitespace-nowrap" style="background: var(--bg-primary);">
                <?php echo t('Stop'); ?>
            </a>
        </div>
    <?php endif; ?>

    <!-- Skip to content link (a11y) -->
    <a href="#main-content" class="skip-to-content"><?php echo e(t('Skip to content')); ?></a>

    <!-- Mobile Overlay -->
    <div id="sidebar-overlay" class="sidebar-overlay fixed inset-0 bg-black bg-opacity-50 z-40 lg:hidden"
        onclick="toggleSidebar()" role="presentation"></div>

    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar fixed top-0 left-0 h-full z-50 flex flex-col" role="complementary" aria-label="<?php echo e(t('Sidebar navigation')); ?>">
        <!-- Logo - Fixed at top -->
        <div class="p-3 flex-shrink-0 flex items-center justify-between">
            <a href="<?php echo url('dashboard'); ?>" class="flex items-center space-x-3 group">
                <?php $app_logo = get_setting('app_logo', ''); ?>
                <?php if ($app_logo): ?>
                    <img src="<?php echo e(upload_url($app_logo)); ?>" alt="<?php echo e($app_name); ?>"
                         class="w-10 h-10 rounded-full object-cover shadow-lg transition-transform group-hover:scale-105">
                <?php else: ?>
                    <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center shadow-lg shadow-blue-500/25 transition-transform group-hover:scale-105">
                        <span class="text-white text-xl font-bold"><?php echo strtoupper(substr($app_name, 0, 1)); ?></span>
                    </div>
                <?php endif; ?>
                <span class="text-xl font-bold text-gradient"><?php echo e($app_name); ?></span>
            </a>
            <!-- Close button for mobile -->
            <button onclick="toggleSidebar()" class="lg:hidden p-2 rounded-xl transition-all" style="color: var(--text-muted);"
                aria-label="<?php echo e(t('Close menu')); ?>" aria-controls="sidebar">
                <?php echo get_icon('times', 'text-xl'); ?>
            </button>
        </div>

        <!-- Scrollable Navigation -->
        <div class="sidebar-nav flex-1 px-2.5 pb-1">
            <!-- Main Navigation -->
            <nav class="space-y-1.5" aria-label="<?php echo e(t('Main navigation')); ?>">
                <?php $is_dashboard = ($page ?? '') === 'dashboard'; ?>
                <a href="<?php echo url('dashboard'); ?>"
                    class="nav-item <?php echo $is_dashboard ? 'active' : ''; ?>"
                    <?php echo $is_dashboard ? 'aria-current="page"' : ''; ?>>
                    <?php echo get_icon('home', 'nav-item__icon'); ?>
                    <span><?php echo e(t('Dashboard')); ?></span>
                </a>

                <?php $is_notifications_page = ($page ?? '') === 'notifications'; ?>
                <a href="<?php echo url('notifications'); ?>"
                    class="nav-item <?php echo $is_notifications_page ? 'active' : ''; ?>"
                    <?php echo $is_notifications_page ? 'aria-current="page"' : ''; ?>>
                    <?php echo get_icon('bell', 'nav-item__icon'); ?>
                    <span><?php echo e(t('Notifications')); ?></span>
                    <span id="sidebar-notif-badge" class="notif-sidebar-badge hidden">0</span>
                </a>

                <?php $is_tickets = ($page ?? '') === 'tickets' && ($_GET['archived'] ?? '') !== '1'; ?>
                <a href="<?php echo url('tickets'); ?>"
                    class="nav-item <?php echo $is_tickets ? 'active' : ''; ?>"
                    <?php echo $is_tickets ? 'aria-current="page"' : ''; ?>>
                    <?php echo get_icon('ticket-alt', 'nav-item__icon'); ?>
                    <span><?php echo e(t('All tickets')); ?></span>
                </a>

                <?php $is_new_ticket = ($page ?? '') === 'new-ticket'; ?>
                <a href="<?php echo url('new-ticket'); ?>"
                    class="nav-item <?php echo $is_new_ticket ? 'active' : ''; ?>"
                    <?php echo $is_new_ticket ? 'aria-current="page"' : ''; ?>>
                    <?php echo get_icon('plus', 'nav-item__icon'); ?>
                    <span><?php echo e(t('New ticket')); ?></span>
                </a>

                <?php if ((is_admin() || is_agent()) && function_exists('ticket_time_table_exists') && ticket_time_table_exists()): ?>
                    <?php $is_quick_start = isset($_GET['auto_timer']); ?>
                    <a href="<?php echo url('new-ticket', ['auto_timer' => '1']); ?>"
                        class="nav-item <?php echo $is_quick_start ? 'active' : ''; ?>"
                        <?php echo $is_quick_start ? 'aria-current="page"' : ''; ?>>
                        <?php echo get_icon('play', 'nav-item__icon'); ?>
                        <span><?php echo e(t('Quick start')); ?></span>
                    </a>
                <?php endif; ?>
            </nav>

            <!-- Active timers (staff only) -->
            <?php if (is_admin() || is_agent()): ?>
                <?php
                $sidebar_timers = [];
                if (function_exists('ticket_time_table_exists') && ticket_time_table_exists() && function_exists('get_user_all_active_timers')) {
                    $sidebar_timers = get_user_all_active_timers($user['id']);
                }
                ?>
                <div id="sidebar-timers" class="mt-3 pt-3 border-t" style="border-color: var(--border-light);<?php echo empty($sidebar_timers) ? ' display:none;' : ''; ?>">
                    <p class="px-3 mb-1.5 text-[10px] font-semibold uppercase tracking-wider flex items-center gap-1.5" style="color: var(--text-muted);">
                        <span class="sidebar-timer-dot"></span>
                        <?php echo e(t('Active Timers')); ?>
                        <span class="sidebar-timer-count"><?php echo count($sidebar_timers); ?></span>
                    </p>
                    <div id="sidebar-timers-list" class="space-y-0.5">
                        <?php foreach ($sidebar_timers as $stimer):
                            $st_paused = is_timer_paused($stimer);
                            $st_elapsed = calculate_timer_elapsed($stimer);
                            $st_minutes = max(0, (int)floor($st_elapsed / 60));
                            $st_url = !empty($stimer['ticket_hash'])
                                ? url('ticket', ['t' => $stimer['ticket_hash']])
                                : url('ticket', ['id' => $stimer['ticket_id']]);
                        ?>
                        <a href="<?php echo $st_url; ?>"
                           class="sidebar-timer-item flex items-center gap-2 px-3 py-1.5 rounded-lg transition-all sidebar-hover"
                           title="<?php echo e($stimer['ticket_title']); ?>">
                            <span class="flex-shrink-0 w-1.5 h-1.5 rounded-full <?php echo $st_paused ? 'bg-yellow-400' : 'sidebar-timer-pulse'; ?>"></span>
                            <span class="flex-1 min-w-0 text-xs truncate" style="color: var(--text-secondary);">
                                <?php echo e($stimer['ticket_title']); ?>
                            </span>
                            <span class="flex-shrink-0 text-[10px] font-mono font-medium <?php echo $st_paused ? '' : 'timer-display'; ?>"
                                  style="color: <?php echo $st_paused ? 'var(--corp-warning, #f59e0b)' : 'var(--corp-success, #10b981)'; ?>;"
                                  <?php if (!$st_paused): ?>
                                  data-started="<?php echo strtotime($stimer['started_at']); ?>"
                                  data-paused-seconds="<?php echo (int)($stimer['paused_seconds'] ?? 0); ?>"
                                  <?php endif; ?>
                            ><?php echo $st_paused ? e(t('Paused')) : e(format_duration_minutes($st_minutes)); ?></span>
                        </a>
                        <?php endforeach; ?>
                    </div>
                </div>
            <?php endif; ?>
        </div>

        <!-- Help Button -->
        <div class="px-2.5 pb-0.5">
            <button onclick="toggleHelpPanel()" id="help-panel-btn"
                class="w-full flex items-center gap-3 p-2 rounded-xl transition-all sidebar-hover"
                style="color: var(--text-muted);"
                title="<?php echo e(t('Help')); ?> (?)">
                <?php echo get_icon('question-circle', 'nav-item__icon'); ?>
                <span class="text-sm"><?php echo e(t('Help')); ?></span>
            </button>
        </div>

        <!-- Sidebar Footer with User Menu -->
        <div class="px-2.5 pt-1 pb-0.5 mt-auto relative"
            style="padding-bottom: max(0.125rem, env(safe-area-inset-bottom));">
            <!-- User Profile Button (clickable for dropdown) -->
            <button onclick="toggleSidebarUserMenu()" id="sidebar-user-btn"
                class="w-full flex items-center gap-3 p-1.5 rounded-xl transition-all cursor-pointer sidebar-hover"
                aria-expanded="false" aria-controls="sidebar-user-menu" aria-haspopup="true">
                <?php if (!empty($user['avatar']) && is_safe_avatar_url($user['avatar'])): ?>
                    <img src="<?php echo e(upload_url($user['avatar'])); ?>" alt="Avatar"
                        class="w-10 h-10 rounded-full object-cover ring-2 ring-blue-500/20 flex-shrink-0"
                        onerror="this.style.display='none';this.nextElementSibling.style.display='flex'">
                    <div class="avatar avatar-md flex-shrink-0" style="border-radius: 12px; display: none;">
                        <?php echo strtoupper(substr($user['first_name'], 0, 1)); ?>
                    </div>
                <?php else: ?>
                    <div class="avatar avatar-md flex-shrink-0" style="border-radius: 12px;">
                        <?php echo strtoupper(substr($user['first_name'], 0, 1)); ?>
                    </div>
                <?php endif; ?>
                <div class="flex-1 min-w-0 text-left">
                    <p class="font-medium text-sm truncate" style="color: var(--text-primary);">
                        <?php echo e($user['first_name'] . ' ' . $user['last_name']); ?>
                    </p>
                    <p class="text-xs truncate" style="color: var(--text-muted);"><?php echo e($user['email']); ?></p>
                </div>
                <span class="sidebar-user-chevron" style="color: var(--text-muted);"><?php echo get_icon('chevron-up', 'w-4 h-4 flex-shrink-0 transition-transform'); ?></span>
            </button>

            <!-- User Dropdown Menu (appears above) -->
            <div id="sidebar-user-menu" class="hidden absolute bottom-full left-4 right-4 mb-2 py-2 rounded-xl shadow-lg z-50"
                role="menu" aria-label="<?php echo e(t('User menu')); ?>"
                style="background: var(--surface-primary); border: 1px solid var(--border-light);">

                <!-- Profile -->
                <a href="<?php echo url('profile'); ?>" role="menuitem"
                    class="flex items-center gap-3 px-4 py-2.5 text-sm transition-colors sidebar-hover"
                    style="color: var(--text-secondary);">
                    <?php echo get_icon('user', 'w-4 h-4'); ?>
                    <span><?php echo e(t('My profile')); ?></span>
                </a>

                <!-- Dark Mode Toggle -->
                <button onclick="toggleTheme(); event.stopPropagation();" role="menuitem"
                    class="w-full flex items-center gap-3 px-4 py-2.5 text-sm transition-colors sidebar-hover"
                    style="color: var(--text-secondary);">
                    <span class="theme-icon-light"><?php echo get_icon('sun', 'w-4 h-4'); ?></span>
                    <span class="theme-icon-dark hidden"><?php echo get_icon('moon', 'w-4 h-4'); ?></span>
                    <span class="theme-text-light"><?php echo e(t('Dark mode')); ?></span>
                    <span class="theme-text-dark hidden"><?php echo e(t('Light mode')); ?></span>
                </button>

                <?php if (is_admin() || is_agent()): ?>
                <div class="border-t my-2" role="separator" style="border-color: var(--border-light);"></div>

                <a href="<?php echo url('admin', ['section' => 'reports']); ?>" role="menuitem"
                    class="flex items-center gap-3 px-4 py-2.5 text-sm transition-colors sidebar-hover"
                    style="color: var(--text-secondary);">
                    <?php echo get_icon('chart-bar', 'w-4 h-4'); ?>
                    <span><?php echo e(t('Time report')); ?></span>
                </a>

                <?php if (is_admin()): ?>
                <a href="<?php echo url('admin', ['section' => 'users']); ?>" role="menuitem"
                    class="flex items-center gap-3 px-4 py-2.5 text-sm transition-colors sidebar-hover"
                    style="color: var(--text-secondary);">
                    <?php echo get_icon('users', 'w-4 h-4'); ?>
                    <span><?php echo e(t('Users')); ?></span>
                </a>
                <a href="<?php echo url('admin', ['section' => 'organizations']); ?>" role="menuitem"
                    class="flex items-center gap-3 px-4 py-2.5 text-sm transition-colors sidebar-hover"
                    style="color: var(--text-secondary);">
                    <?php echo get_icon('building', 'w-4 h-4'); ?>
                    <span><?php echo e(t('Organizations')); ?></span>
                </a>
                <a href="<?php echo url('admin', ['section' => 'settings']); ?>" role="menuitem"
                    class="flex items-center gap-3 px-4 py-2.5 text-sm transition-colors sidebar-hover"
                    style="color: var(--text-secondary);">
                    <?php echo get_icon('cog', 'w-4 h-4'); ?>
                    <span><?php echo e(t('Settings')); ?></span>
                </a>
                <a href="<?php echo url('admin', ['section' => 'recurring-tasks']); ?>" role="menuitem"
                    class="flex items-center gap-3 px-4 py-2.5 text-sm transition-colors sidebar-hover"
                    style="color: var(--text-secondary);">
                    <?php echo get_icon('sync-alt', 'w-4 h-4'); ?>
                    <span><?php echo e(t('Recurring tasks')); ?></span>
                </a>
                <a href="<?php echo url('tickets', ['archived' => '1']); ?>" role="menuitem"
                    class="flex items-center gap-3 px-4 py-2.5 text-sm transition-colors sidebar-hover"
                    style="color: var(--text-secondary);">
                    <?php echo get_icon('archive', 'w-4 h-4'); ?>
                    <span><?php echo e(t('Archive')); ?></span>
                </a>
                <?php endif; ?>
                <?php endif; ?>

                <div class="border-t my-2" role="separator" style="border-color: var(--border-light);"></div>

                <!-- Logout -->
                <a href="<?php echo url('logout'); ?>" role="menuitem"
                    class="flex items-center gap-3 px-4 py-2.5 text-sm text-red-600 transition-colors hover:bg-red-50">
                    <?php echo get_icon('sign-out-alt', 'w-4 h-4'); ?>
                    <span><?php echo e(t('Sign out')); ?></span>
                </a>
            </div>
        </div>
    </aside>

    <?php include __DIR__ . '/help-panel.php'; ?>

    <!-- Main Content -->
    <main id="main-content" class="main-content min-h-screen">
        <!-- Mobile Header -->
        <header class="mobile-header bg-white dark:bg-gray-900 border-b border-gray-200 dark:border-gray-800 px-4 py-3 flex items-center justify-between sticky top-0 z-30">
            <button onclick="toggleSidebar()" id="mobile-menu-btn" class="p-2 rounded-xl transition-all sidebar-hover" style="color: var(--text-secondary);" aria-label="<?php echo e(t('Open menu')); ?>" aria-expanded="false" aria-controls="sidebar">
                <?php echo get_icon('bars', 'text-xl'); ?>
            </button>
            <h1 class="text-lg font-semibold truncate flex-1 mx-4" style="color: var(--text-primary);">
                <?php echo e($page_title ?? t('Dashboard')); ?>
            </h1>
            <div class="flex items-center space-x-2">
                <!-- Notification Bell (Mobile) -->
                <div class="relative">
                    <button onclick="toggleNotificationPanel()" id="mobile-notif-btn"
                        class="p-2 rounded-xl transition-all sidebar-hover relative" style="color: var(--text-secondary);"
                        aria-label="<?php echo e(t('Notifications')); ?>" aria-expanded="false">
                        <?php echo get_icon('bell', 'w-5 h-5'); ?>
                        <span id="notif-badge-mobile" class="notif-badge hidden">0</span>
                    </button>
                </div>

                <a href="<?php echo url('tickets'); ?>" class="p-2 rounded-xl transition-all sidebar-hover" style="color: var(--text-secondary);"
                    aria-label="<?php echo e(t('Search tickets')); ?>">
                    <?php echo get_icon('search'); ?>
                </a>

                <!-- Mobile User Dropdown -->
                <div class="relative">
                    <button onclick="toggleUserDropdownMobile()" id="mobile-user-btn"
                        class="p-1 rounded-xl transition-all sidebar-hover" style="color: var(--text-secondary);"
                        aria-label="<?php echo e(t('User menu')); ?>" aria-expanded="false" aria-controls="user-dropdown-mobile" aria-haspopup="true">
                        <?php if (!empty($user['avatar']) && is_safe_avatar_url($user['avatar'])): ?>
                            <img src="<?php echo e(upload_url($user['avatar'])); ?>" alt="Avatar"
                                class="w-8 h-8 rounded-full object-cover ring-2 ring-blue-500/20"
                                onerror="this.style.display='none';this.nextElementSibling.style.display='flex'">
                            <div class="avatar avatar-sm" style="border-radius: 10px; display: none;">
                                <?php echo strtoupper(substr($user['first_name'], 0, 1)); ?>
                            </div>
                        <?php else: ?>
                            <div class="avatar avatar-sm" style="border-radius: 10px;">
                                <?php echo strtoupper(substr($user['first_name'], 0, 1)); ?>
                            </div>
                        <?php endif; ?>
                    </button>

                    <!-- Mobile Dropdown Menu -->
                    <div id="user-dropdown-mobile" role="menu" aria-label="<?php echo e(t('User menu')); ?>"
                        class="hidden absolute right-0 mt-2 w-52 glass py-2 z-50 animate-scale-in rounded-xl">
                        <div class="px-4 py-3 border-b" style="border-color: var(--border-light);">
                            <p class="font-semibold truncate" style="color: var(--text-primary);">
                                <?php echo e($user['first_name'] . ' ' . $user['last_name']); ?>
                            </p>
                            <p class="text-xs truncate" style="color: var(--text-muted);"><?php echo e($user['email']); ?></p>
                        </div>
                        <a href="<?php echo url('profile'); ?>" role="menuitem"
                            class="flex items-center space-x-3 px-4 py-2.5 text-sm transition-colors sidebar-hover" style="color: var(--text-secondary);">
                            <?php echo get_icon('user', 'w-4 opacity-70'); ?>
                            <span><?php echo e(t('My profile')); ?></span>
                        </a>
                        <a href="<?php echo url('logout'); ?>" role="menuitem"
                            class="flex items-center space-x-3 px-4 py-2.5 text-sm text-red-600 hover:bg-red-50 transition-colors">
                            <?php echo get_icon('sign-out-alt', 'w-4 opacity-70'); ?>
                            <span><?php echo e(t('Sign out')); ?></span>
                        </a>
                    </div>
                </div>
            </div>
        </header>

        <!-- Desktop Header -->
        <header class="desktop-header bg-white dark:bg-gray-900 border-b border-gray-200 dark:border-gray-800 px-6 py-3 flex items-center justify-between sticky top-0 z-30 w-full">
            <h1 class="text-lg font-semibold" style="color: var(--text-primary);"><?php echo e($page_title ?? t('Dashboard')); ?></h1>
            <div class="flex items-center space-x-4">
                <form action="<?php echo url('tickets'); ?>" method="get" class="relative">
                    <input type="hidden" name="page" value="tickets">
                    <input type="text" name="search" id="header-search" placeholder="<?php echo e(t('Search...')); ?>"
                        class="form-input pr-4 header-search-input" style="width: clamp(200px, 25vw, 320px); border-radius: 10px; padding-left: 2.25rem;">
                    <span class="absolute top-1/2 transform -translate-y-1/2" style="left: 1rem; color: var(--text-muted); pointer-events: none;">
                        <?php echo get_icon('search', 'w-4 h-4'); ?>
                    </span>
                </form>

                <!-- Notification Bell (Desktop) -->
                <div class="relative">
                    <button onclick="toggleNotificationPanel()" id="desktop-notif-btn"
                        class="p-2 rounded-xl transition-all sidebar-hover relative" style="color: var(--text-secondary);"
                        aria-label="<?php echo e(t('Notifications')); ?>" aria-expanded="false">
                        <?php echo get_icon('bell', 'w-5 h-5'); ?>
                        <span id="notif-badge-desktop" class="notif-badge hidden">0</span>
                    </button>
                </div>

                <style>
                    [data-theme="dark"] .header-search-input,
                    [data-theme="dark"] #header-search {
                        background: #334155 !important;
                        color: #f1f5f9 !important;
                        border-color: #475569 !important;
                    }
                    [data-theme="dark"] .header-search-input::placeholder,
                    [data-theme="dark"] #header-search::placeholder {
                        color: #cbd5e1 !important;
                        opacity: 1 !important;
                    }
                    [data-theme="dark"] .header-search-input::-webkit-input-placeholder,
                    [data-theme="dark"] #header-search::-webkit-input-placeholder {
                        color: #cbd5e1 !important;
                        opacity: 1 !important;
                    }
                </style>

            </div>
        </header>

        <!-- Notification Panel (shared between mobile & desktop) -->
        <div id="notification-panel" class="hidden fixed z-50 glass rounded-xl shadow-2xl animate-scale-in"
            style="width: min(396px, calc(100vw - 2rem)); max-height: 480px; right: 1rem; top: 3.5rem;">
            <!-- Header -->
            <div class="flex items-center justify-between px-4 py-3 border-b" style="border-color: var(--border-light);">
                <h3 class="font-semibold text-sm" style="color: var(--text-primary);"><?php echo e(t('Notifications')); ?></h3>
                <button onclick="markAllNotificationsRead()" id="notif-mark-all-btn"
                    class="text-xs font-medium hover:underline" style="color: var(--accent-primary);">
                    <?php echo e(t('Mark all as read')); ?>
                </button>
            </div>
            <!-- Content -->
            <div id="notification-list" class="overflow-y-auto" style="max-height: 420px;">
                <div id="notif-loading" class="flex items-center justify-center py-8">
                    <div class="w-5 h-5 border-2 rounded-full animate-spin" style="border-color: var(--border-light); border-top-color: var(--accent-primary);"></div>
                </div>
                <div id="notif-empty" class="hidden text-center py-8 px-4">
                    <div style="color: var(--text-muted);" class="mb-2"><?php echo get_icon('bell', 'w-8 h-8 mx-auto opacity-30'); ?></div>
                    <p class="text-sm" style="color: var(--text-muted);"><?php echo e(t('No notifications yet')); ?></p>
                </div>
                <div id="notif-items"></div>
            </div>
        </div>

        <!-- Flash / Toast Notifications -->
        <div id="app-toast-stack" class="toast-stack" aria-live="polite" aria-atomic="true">
            <?php if ($flash && $in_app_notifications_enabled): ?>
                <?php include BASE_PATH . '/includes/components/flash.php'; ?>
            <?php endif; ?>
        </div>
        <?php if ($flash && !$in_app_notifications_enabled): ?>
            <div class="mx-4 lg:mx-8 mt-4 flash-inline-wrapper">
                <?php include BASE_PATH . '/includes/components/flash.php'; ?>
            </div>
        <?php endif; ?>

        <?php if ($_foxdesk_update_info && !is_update_dismissed($_foxdesk_update_info['version'])): ?>
        <!-- Update Available Banner -->
        <div class="foxdesk-update-bar" id="foxdeskUpdateBar">
            <div class="foxdesk-update-bar-inner">
                <div class="foxdesk-update-bar-content">
                    <span class="foxdesk-update-bar-icon">đź¦Š</span>
                    <span class="foxdesk-update-bar-text">
                        <?php echo e(t('FoxDesk {version} is available!', ['version' => $_foxdesk_update_info['version']])); ?>
                    </span>
                    <a href="<?php echo url('admin', ['section' => 'settings', 'tab' => 'system']); ?>#updates" class="foxdesk-update-bar-btn">
                        <?php echo e(t('Update now')); ?>
                    </a>
                </div>
                <button type="button" class="foxdesk-update-bar-dismiss" onclick="dismissFoxDeskUpdate('<?php echo e($_foxdesk_update_info['version']); ?>')" title="<?php echo e(t('Dismiss')); ?>">âś•</button>
            </div>
        </div>
        <script>
        function dismissFoxDeskUpdate(version) {
            var bar = document.getElementById('foxdeskUpdateBar');
            if (bar) bar.style.display = 'none';
            fetch('api.php?action=dismiss-update-notice', {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'X-CSRF-Token': window.csrfToken},
                body: JSON.stringify({version: version})
            }).catch(function() {});
        }
        </script>
        <?php endif; ?>

        <!-- Notification Center CSS -->
        <style>
            .notif-badge {
                position: absolute;
                top: 2px; right: 2px;
                min-width: 18px; height: 18px;
                padding: 0 5px;
                font-size: 11px; font-weight: 600; line-height: 18px;
                text-align: center;
                color: #fff;
                background: #ef4444;
                border-radius: 9px;
                pointer-events: none;
            }
            .notif-badge.pulse {
                animation: notif-pulse 2s ease-in-out infinite;
            }
            .notif-sidebar-badge {
                margin-left: auto;
                min-width: 18px; height: 18px;
                padding: 0 5px;
                font-size: 11px; font-weight: 600; line-height: 18px;
                text-align: center;
                color: #fff;
                background: #ef4444;
                border-radius: 9px;
            }
            @keyframes notif-pulse {
                0%, 100% { transform: scale(1); }
                50% { transform: scale(1.15); }
            }
            .notif-item {
                display: flex;
                align-items: flex-start;
                gap: 0.75rem;
                padding: 0.75rem 1rem;
                cursor: pointer;
                transition: background 0.15s;
                border-left: 3px solid transparent;
            }
            .notif-item:hover {
                background: var(--surface-hover, rgba(0,0,0,0.03));
            }
            [data-theme="dark"] .notif-item:hover {
                background: rgba(255,255,255,0.05);
            }
            .notif-item.unread {
                border-left-color: var(--accent-primary, #3b82f6);
            }
            .notif-item .notif-avatar {
                width: 32px; height: 32px;
                border-radius: 8px;
                flex-shrink: 0;
                display: flex; align-items: center; justify-content: center;
                font-size: 13px; font-weight: 600;
                color: #fff;
                background: var(--text-muted, #9ca3af);
                overflow: hidden;
            }
            .notif-item .notif-avatar img {
                width: 100%; height: 100%; object-fit: cover;
            }
            .notif-item .notif-body {
                flex: 1; min-width: 0;
            }
            .notif-item .notif-text {
                font-size: 13px; line-height: 1.4;
                color: var(--text-secondary);
            }
            .notif-item.unread .notif-text {
                color: var(--text-primary);
                font-weight: 500;
            }
            .notif-item .notif-time {
                font-size: 11px;
                color: var(--text-muted);
                margin-top: 2px;
            }
            .notif-group-header {
                padding: 0.5rem 1rem 0.25rem;
                font-size: 11px; font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.05em;
                color: var(--text-muted);
            }
            #notification-list::-webkit-scrollbar { width: 4px; }
            #notification-list::-webkit-scrollbar-track { background: transparent; }
            #notification-list::-webkit-scrollbar-thumb { background: var(--border-light); border-radius: 2px; }
        </style>

        <!-- Notification Center JS -->
        <script>
        (function() {
            var _notifPanel = null;
            var _notifLoaded = false;
            var _notifOpen = false;
            var _pollInterval = null;
            var _lastCount = 0;

            function esc(s) {
                var d = document.createElement('div');
                d.textContent = s || '';
                return d.innerHTML;
            }

            function avatarColor(name) {
                var h = 0;
                for (var i = 0; i < (name||'').length; i++) h = (name.charCodeAt(i) + ((h << 5) - h)) | 0;
                return 'hsl(' + (Math.abs(h) % 360) + ', 55%, 60%)';
            }

            function avatarUrl(path) {
                if (!path) return '';
                if (path.indexOf('data:') === 0 || path.indexOf('http') === 0) return path;
                // Use image.php proxy — extract filename from e.g. "uploads/avatar_emily.png"
                var filename = path.split('/').pop().split('?')[0];
                return 'image.php?f=' + encodeURIComponent(filename);
            }

            function avatarHtml(n) {
                if (n.actor_avatar) {
                    var src = avatarUrl(n.actor_avatar);
                    var fallbackInit = esc((n.actor_name||'?').charAt(0).toUpperCase());
                    return '<div class="notif-avatar" style="background:' + avatarColor(n.actor_name) + '"><img src="' + esc(src) + '" onerror="this.style.display=\'none\';this.parentElement.textContent=\'' + fallbackInit + '\'"></div>';
                }
                var init = (n.actor_name || '?').charAt(0).toUpperCase();
                return '<div class="notif-avatar" style="background:' + avatarColor(n.actor_name) + '">' + esc(init) + '</div>';
            }

            function renderItem(n) {
                var cls = 'notif-item' + (n.is_read ? '' : ' unread');
                var ticketUrl = n.ticket_id ? ('index.php?page=ticket&id=' + n.ticket_id) : '#';
                return '<div class="' + cls + '" data-id="' + n.id + '" onclick="notifItemClick(event,' + n.id + ',' + (n.ticket_id||0) + ')">'
                    + avatarHtml(n)
                    + '<div class="notif-body">'
                    + '<div class="notif-text">' + esc(n.text) + '</div>'
                    + '<div class="notif-time">' + esc(n.time_ago) + '</div>'
                    + '</div></div>';
            }

            function renderGroup(label, items) {
                if (!items || items.length === 0) return '';
                var html = '<div class="notif-group-header">' + esc(label) + '</div>';
                for (var i = 0; i < items.length; i++) html += renderItem(items[i]);
                return html;
            }

            window.toggleNotificationPanel = function() {
                _notifPanel = document.getElementById('notification-panel');
                if (!_notifPanel) return;

                _notifOpen = !_notifOpen;
                if (_notifOpen) {
                    _notifPanel.classList.remove('hidden');
                    // Position for mobile vs desktop
                    if (window.innerWidth < 1024) {
                        _notifPanel.style.top = '3.5rem';
                        _notifPanel.style.right = '0.5rem';
                    } else {
                        _notifPanel.style.top = '3.5rem';
                        _notifPanel.style.right = '1rem';
                    }
                    if (!_notifLoaded) loadNotifications();
                } else {
                    _notifPanel.classList.add('hidden');
                }
            };

            window.notifItemClick = function(event, id, ticketId) {
                // Mark as read
                var el = event.currentTarget;
                if (el && el.classList.contains('unread')) {
                    el.classList.remove('unread');
                    fetch('index.php?page=api&action=mark-notification-read', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/x-www-form-urlencoded', 'X-CSRF-Token': window.csrfToken},
                        body: 'notification_id=' + id + '&csrf_token=' + encodeURIComponent(window.csrfToken)
                    }).catch(function(){});
                }
                // Navigate to ticket (nid for server-side mark-read)
                if (ticketId) {
                    window.location.href = 'index.php?page=ticket&id=' + ticketId + '&nid=' + id;
                }
            };

            window.markAllNotificationsRead = function() {
                fetch('index.php?page=api&action=mark-all-notifications-read', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded', 'X-CSRF-Token': window.csrfToken},
                    body: 'csrf_token=' + encodeURIComponent(window.csrfToken)
                }).then(function() {
                    // Visual update
                    document.querySelectorAll('.notif-item.unread').forEach(function(el) { el.classList.remove('unread'); });
                    updateBadge(0);
                }).catch(function(){});
            };

            function loadNotifications() {
                var loading = document.getElementById('notif-loading');
                var empty = document.getElementById('notif-empty');
                var items = document.getElementById('notif-items');
                if (loading) loading.classList.remove('hidden');
                if (empty) empty.classList.add('hidden');
                if (items) items.innerHTML = '';

                fetch('index.php?page=api&action=get-notifications')
                    .then(function(r) { return r.json(); })
                    .then(function(res) {
                        if (loading) loading.classList.add('hidden');
                        if (!res.success || !res.groups) { if (empty) empty.classList.remove('hidden'); return; }

                        var g = res.groups || {};
                        var html = '';
                        html += renderGroup(<?php echo json_encode(t('Today')); ?>, g.today);
                        html += renderGroup(<?php echo json_encode(t('Yesterday')); ?>, g.yesterday);
                        html += renderGroup(<?php echo json_encode(t('Earlier')); ?>, g.earlier);

                        if (!html) {
                            if (empty) empty.classList.remove('hidden');
                        } else {
                            if (items) items.innerHTML = html;
                        }

                        updateBadge(res.unread_count || 0);
                        _notifLoaded = true;
                    })
                    .catch(function() {
                        if (loading) loading.classList.add('hidden');
                        if (empty) empty.classList.remove('hidden');
                    });
            }

            function updateBadge(count) {
                _lastCount = count;
                ['notif-badge-mobile', 'notif-badge-desktop', 'sidebar-notif-badge'].forEach(function(id) {
                    var el = document.getElementById(id);
                    if (!el) return;
                    if (count > 0) {
                        el.textContent = count > 99 ? '99+' : count;
                        el.classList.remove('hidden');
                        if (id !== 'sidebar-notif-badge') el.classList.add('pulse');
                    } else {
                        el.classList.add('hidden');
                        if (id !== 'sidebar-notif-badge') el.classList.remove('pulse');
                    }
                });
            }

            function pollCount() {
                fetch('index.php?page=api&action=get-notification-count')
                    .then(function(r) { return r.json(); })
                    .then(function(res) {
                        if (res.success) {
                            var newCount = res.unread_count || 0;
                            if (newCount > _lastCount && newCount > 0) {
                                // New notifications arrived
                                if (window.appNotificationPrefs && window.appNotificationPrefs.soundEnabled) {
                                    playNotifSound();
                                }
                                _notifLoaded = false; // Force reload on next open
                            }
                            updateBadge(newCount);
                        }
                    })
                    .catch(function(){});
            }

            function playNotifSound() {
                try {
                    var ctx = new (window.AudioContext || window.webkitAudioContext)();
                    var osc = ctx.createOscillator();
                    var gain = ctx.createGain();
                    osc.connect(gain);
                    gain.connect(ctx.destination);
                    osc.frequency.value = 880;
                    osc.type = 'sine';
                    gain.gain.value = 0.1;
                    gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.3);
                    osc.start();
                    osc.stop(ctx.currentTime + 0.3);
                } catch(e) {}
            }

            // Close panel on outside click
            document.addEventListener('click', function(e) {
                if (!_notifOpen) return;
                var panel = document.getElementById('notification-panel');
                var mBtn = document.getElementById('mobile-notif-btn');
                var dBtn = document.getElementById('desktop-notif-btn');
                if (panel && !panel.contains(e.target) && (!mBtn || !mBtn.contains(e.target)) && (!dBtn || !dBtn.contains(e.target))) {
                    _notifOpen = false;
                    panel.classList.add('hidden');
                }
            });

            // Init on page load
            document.addEventListener('DOMContentLoaded', function() {
                // Initial count check
                pollCount();
                // Poll every 60 seconds
                _pollInterval = setInterval(pollCount, 60000);
            });
        })();
        </script>

        <!-- Page Content -->
        <div class="p-2 lg:p-3 xl:p-4">

            <!-- JS moved to assets/js/app-header.js (defer) -->


